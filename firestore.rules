
/**
 * Core Philosophy:
 * This ruleset implements a Role-Based Access Control (RBAC) model. A user's
 * administrative privileges are determined by the existence of a document
 * corresponding to their user ID in the '/roles_admin' collection.
 * Content collections (events, testimonials, team members) are
 * generally public to read, but all write operations (create, update, delete)
 * are restricted to authenticated administrators.
 * Forum posts can be created by anyone, but can only be answered by admins.
 * Users can edit/delete their own posts one time via a secret token.
 *
 * Data Structure:
 * The data is organized into several flat, top-level collections:
 * - /events: Stores event information.
 * - /testimonials: Stores member testimonials.
 * - /team_members: Stores profiles of team members.
 * - /forum_posts: Stores public questions and admin-provided answers.
 * - /roles_admin: A special collection used solely for authorization. The
 *   presence of a document /roles_admin/{userId} grants admin rights.
 * This flat structure simplifies security rules and improves performance by
 * avoiding complex, nested reads for authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is an administrator.
     * Admin status is granted if a document with the user's UID exists in the
     * '/roles_admin' collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to event data. Events are public to read but
     * can only be created, modified, or deleted by an administrator.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to testimonials. Testimonials are public to
     * read but can only be created, modified, or deleted by an administrator.
     * @path /testimonials/{testimonialId}
     */
    match /testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to team member profiles. These profiles are
     * public to read but can only be managed by administrators.
     * @path /team_members/{teamMemberId}
     */
    match /team_members/{teamMemberId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to forum posts. Posts are public to read,
     * can be created by any user. Admins can answer/delete any post.
     * Anonymous users can edit/delete their own post if they provide a secret.
     * @path /forum_posts/{forumPostId}
     */
    match /forum_posts/{forumPostId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin() || request.resource.data.secret == resource.data.secret;
    }

    /**
     * @description Secures the admin role collection. This collection is used for
     * authorization checks only and should never be modified by any client.
     * All client-side access is denied to prevent privilege escalation.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if false;
    }
  }
}
