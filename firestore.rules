
/**
 * Core Philosophy:
 * This ruleset implements a Role-Based Access Control (RBAC) model. A user's
 * administrative privileges are determined by the existence of a document
 * corresponding to their user ID in the '/roles_admin' collection.
 * Content collections (events, testimonials, team members) are
 * generally public to read, but all write operations (create, update, delete)
 * are restricted to authenticated administrators.
 * The forum is open: anyone can read, create posts, and add replies.
 * Only administrators can modify or delete forum content, close threads,
 * or post replies as an admin.
 *
 * Data Structure:
 * The data is organized into several flat, top-level collections:
 * - /events: Stores event information.
 * - /testimonials: Stores member testimonials.
 * - /team_members: Stores profiles of team members.
 * - /forum_posts: Stores public questions and their reply threads.
 * - /roles_admin: A special collection used solely for authorization. The
 *   presence of a document /roles_admin/{userId} grants admin rights.
 * This flat structure simplifies security rules and improves performance by
 * avoiding complex, nested reads for authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is an administrator.
     * Admin status is granted if a document with the user's UID exists in the
     * '/roles_admin' collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Validates the schema for a new forum post.
     * Ensures required fields are present and correctly typed.
     */
    function isValidNewForumPost() {
      let post = request.resource.data;
      return post.authorName is string && post.authorName.size() > 0 &&
             post.question is string && post.question.size() > 0 &&
             post.replies is list && post.replies.size() == 0 &&
             post.timestamp == request.time &&
             post.isClosed == false;
    }

    /**
     * Validates an incoming public reply being added to the replies array.
     * Ensures the thread is not closed and the reply is not an admin reply.
     */
    function isValidNewPublicReply() {
        let newReply = request.resource.data.replies[request.resource.data.replies.size() - 1];
        return request.resource.data.replies.size() == resource.data.replies.size() + 1 &&
               resource.data.isClosed != true &&
               newReply.isAdminReply == false;
    }
    
    /**
     * Checks if an admin is performing a valid update.
     * Admins can:
     * - Change the question text.
     * - Close or re-open a thread.
     * - Add or remove replies.
     * - Post admin-badged replies.
     */
    function isValidAdminUpdate() {
      // Allows admins to modify any field except for the original author/timestamp
      let post = request.resource.data;
      let existingPost = resource.data;
      return isAdmin() &&
             post.authorName == existingPost.authorName &&
             post.timestamp == existingPost.timestamp;
    }


    /**
     * Validates the schema of a reply object.
     */
    function isReply(reply) {
      return reply.id is string &&
             reply.authorName is string &&
             reply.reply is string &&
             reply.timestamp is timestamp &&
             reply.isAdminReply is bool;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to event data. Events are public to read but
     * can only be created, modified, or deleted by an administrator.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow read, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to testimonials. Testimonials are public to
     * read but can only be created, modified, or deleted by an administrator.
     * @path /testimonials/{testimonialId}
     */
    match /testimonials/{testimonialId} {
      allow read, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to team member profiles. These profiles are
     * public to read but can only be managed by administrators.
     * @path /team_members/{teamMemberId}
     */
    match /team_members/{teamMemberId} {
      allow read, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to forum posts.
     * Anyone can read or create a post. Anyone can add a public reply to an open thread.
     * Admins can update any part of the post, delete it, close/open it, and add admin replies.
     * @path /forum_posts/{forumPostId}
     */
    match /forum_posts/{forumPostId} {
      allow read, list: if true;
      allow create: if isValidNewForumPost();
      allow update: if isValidNewPublicReply() || isValidAdminUpdate();
      allow delete: if isAdmin();
    }

    /**
     * @description Secures the admin role collection. This collection is used for
     * authorization checks only and should never be modified by any client.
     * All client-side access is denied to prevent privilege escalation.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if false;
    }
  }
}
