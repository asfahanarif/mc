
/**
 * Core Philosophy:
 * This ruleset implements a Role-Based Access Control (RBAC) model. A user's
 * administrative privileges are determined by the existence of a document
 * corresponding to their user ID in the '/roles_admin' collection.
 * Content collections (events, testimonials, team members) are
 * generally public to read, but all write operations (create, update, delete)
 * are restricted to authenticated administrators.
 * Forum posts can be created by anyone. Users can edit/delete their own
 * initial post one-time via a secret token. They can also reply to threads
 * they started if they provide the same secret. Admins can manage all forum content.
 *
 * Data Structure:
 * The data is organized into several flat, top-level collections:
 * - /events: Stores event information.
 * - /testimonials: Stores member testimonials.
 * - /team_members: Stores profiles of team members.
 * - /forum_posts: Stores public questions and their reply threads.
 * - /roles_admin: A special collection used solely for authorization. The
 *   presence of a document /roles_admin/{userId} grants admin rights.
 * This flat structure simplifies security rules and improves performance by
 * avoiding complex, nested reads for authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is an administrator.
     * Admin status is granted if a document with the user's UID exists in the
     * '/roles_admin' collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Validates the fields of a new forum post.
     */
    function isValidNewPost() {
      return request.resource.data.authorName is string &&
             request.resource.data.question is string &&
             request.resource.data.replies.size() == 0 &&
             request.resource.data.isAnswered == false &&
             request.resource.data.timestamp == request.time;
    }

    /**
     * Validates an admin's reply.
     */
    function isValidAdminReply(post) {
      let reply = request.resource.data.replies[request.resource.data.replies.size() - 1];
      return request.resource.data.replies.size() == post.replies.size() + 1 &&
             reply.authorType == 'admin' &&
             reply.authorName == 'Admin' &&
             reply.reply is string &&
             reply.timestamp == request.time;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to event data. Events are public to read but
     * can only be created, modified, or deleted by an administrator.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to testimonials. Testimonials are public to
     * read but can only be created, modified, or deleted by an administrator.
     * @path /testimonials/{testimonialId}
     */
    match /testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to team member profiles. These profiles are
     * public to read but can only be managed by administrators.
     * @path /team_members/{teamMemberId}
     */
    match /team_members/{teamMemberId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Controls access to forum posts.
     * Anyone can read or create a post.
     * Admins can read, update (reply to), and delete any post.
     * @path /forum_posts/{forumPostId}
     */
    match /forum_posts/{forumPostId} {
      // Anyone can read a single post. Admins can list all posts.
      allow get: if true;
      allow list: if isAdmin();
      // Anyone can create a new post, if the data is valid.
      allow create: if isValidNewPost();
      // Admins can update posts (to add replies) or delete them.
      allow update: if isAdmin() && isValidAdminReply(resource.data);
      allow delete: if isAdmin();
    }

    /**
     * @description Secures the admin role collection. This collection is used for
     * authorization checks only and should never be modified by any client.
     * All client-side access is denied to prevent privilege escalation.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if false;
    }
  }
}
